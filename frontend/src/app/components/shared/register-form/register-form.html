@if (isOpen) {
  <aside 
    class="register-modal__overlay" 
    (click)="onOverlayClick($event)"
    role="dialog"
    aria-modal="true"
    aria-labelledby="register-modal-title">
    <article 
      #modalContainer
      class="register-modal"
      (click)="onModalClick($event)">
      <header class="register-modal__header">
        <h2 id="register-modal-title" class="register-modal__title">Crear cuenta</h2>
        <button 
          #closeButton
          class="register-modal__close" 
          (click)="closeModal()"
          (keydown)="onCloseKeyDown($event)"
          aria-label="Cerrar modal"
          type="button">
          <fa-icon [icon]="['fas', 'times']"></fa-icon>
        </button>
      </header>

      <form class="register-modal__form" [formGroup]="registerForm" (ngSubmit)="onSubmit($event)">
        <fieldset class="register-modal__fieldset">
          <legend class="register-modal__legend">Datos de registro</legend>

          <section class="register-modal__field-wrapper">
            <app-form-input
              label="Email"
              type="email"
              name="email"
              placeholder=""
              [required]="true"
              [errorMessage]="emailError"
              [value]="registerForm.get('email')?.value || ''"
              (valueChange)="registerForm.get('email')?.setValue($event)"
              (inputBlur)="onEmailBlur()">
            </app-form-input>
            @if (isEmailValidating) {
              <span class="register-modal__validating">Verificando email...</span>
            }
          </section>

          <section class="register-modal__field-wrapper">
            <app-form-input
              label="Nombre de usuario"
              type="text"
              name="username"
              placeholder=""
              [required]="true"
              [errorMessage]="usernameError"
              [value]="registerForm.get('username')?.value || ''"
              (valueChange)="registerForm.get('username')?.setValue($event)"
              (inputBlur)="onUsernameBlur()">
            </app-form-input>
            @if (isUsernameValidating) {
              <span class="register-modal__validating">Verificando disponibilidad...</span>
            }
          </section>

          <section class="register-modal__field-wrapper">
            <app-form-input
              label="Contraseña"
              type="password"
              name="password"
              placeholder=""
              [required]="true"
              [errorMessage]="passwordError"
              [value]="registerForm.get('password')?.value || ''"
              (valueChange)="registerForm.get('password')?.setValue($event)"
              (inputBlur)="onPasswordBlur()">
            </app-form-input>
            @if (registerForm.get('password')?.value) {
              <aside class="register-modal__strength" aria-label="Indicador de fortaleza de contraseña">
                <progress class="register-modal__strength-bar" max="4" [value]="passwordStrength">
                  <span 
                    class="register-modal__strength-fill"
                    [attr.data-strength]="passwordStrength"
                    [style.width.%]="passwordStrength * 25">
                  </span>
                </progress>
                <span class="register-modal__strength-text" [attr.data-strength]="passwordStrength">
                  {{ passwordStrengthText }}
                </span>
              </aside>
            }
          </section>
        </fieldset>

        <footer class="register-modal__actions">
          <button 
            type="submit" 
            class="register-modal__submit" 
            [disabled]="!isFormValid || isFormPending"
            [attr.aria-disabled]="!isFormValid || isFormPending">
            @if (isFormPending) {
              Verificando...
            } @else {
              Crear cuenta
            }
          </button>
          
          <p class="register-modal__switch">
            ¿Ya tienes cuenta? 
            <button 
              type="button" 
              class="register-modal__switch-link"
              (click)="goToLogin()">
              Inicia sesión
            </button>
          </p>
        </footer>
      </form>
    </article>
  </aside>
}
