<header class="header" #headerContainer>
  <section class="header__container">
    <a routerLink="/" class="header__logo">
      <picture>
        <source
          media="(max-width: 640px)"
          srcset="assets/img/logos/logoL4R-small.webp"
        >
        <source
          media="(max-width: 1024px)"
          srcset="assets/img/logos/logoL4R-medium.webp"
        >
        <img
          src="assets/img/logos/logoL4R-large.webp"
          alt="Looking4Rate Logo"
          class="header__logo-img"
          width="461"
          height="135"
          loading="eager"
        >
      </picture>
    </a>

    <!-- Navegación desktop -->
    <nav class="header__actions header__actions--desktop">
      <app-theme-switcher></app-theme-switcher>
      
      <!-- Mostrar botones de login/registro si NO está autenticado -->
      @if (!authState.isAuthenticated) {
        <app-button variant="primary" size="md" (btnClick)="loginClick.emit()">INICIAR SESIÓN</app-button>
        <app-button variant="primary" size="md" (btnClick)="registerClick.emit()">CREAR CUENTA</app-button>
      }
      
      <!-- Mostrar dropdown de usuario si SÍ está autenticado -->
      @if (authState.isAuthenticated && authState.user) {
        <app-user-dropdown
          [userName]="authState.user.nombre"
          (navigateHome)="goToHome()"
          (navigateProfile)="goToProfile()"
          (navigateSettings)="goToSettings()"
          (logoutClick)="logout()">
        </app-user-dropdown>
      }
      
      <app-search-box 
        placeholder="Buscar juegos..."
        [(value)]="searchQuery"
        (search)="onSearch($event)">
      </app-search-box>
    </nav>

    <!-- Controles móvil (solo visibles en móvil) -->
    <menu class="header__mobile-controls">
      <!-- Toggle de tema -->
      <app-theme-switcher></app-theme-switcher>
      
      <!-- Botón de búsqueda móvil (solo icono) - abre buscador expandido -->
      <app-search-box 
        variant="icon-only"
        (iconClick)="toggleMobileSearch()">
      </app-search-box>

      <!-- Botón hamburguesa con manejo de eventos mejorado -->
      <button 
        #hamburgerBtn
        class="header__hamburger" 
        [class.header__hamburger--active]="isMenuOpen"
        (click)="toggleMenu($event)"
        (keydown)="onHamburgerKeyDown($event)"
        aria-label="Menú de navegación"
        [attr.aria-expanded]="isMenuOpen"
        aria-controls="mobile-menu"
        type="button">
        <span class="header__hamburger-line"></span>
        <span class="header__hamburger-line"></span>
        <span class="header__hamburger-line"></span>
      </button>
    </menu>

    <!-- Menú móvil con referencias para manipulación DOM -->
    <nav 
      #mobileMenu
      id="mobile-menu"
      class="header__mobile-menu" 
      [class.header__mobile-menu--open]="isMenuOpen"
      [attr.aria-hidden]="!isMenuOpen"
      role="menu">
      <ul class="header__mobile-menu-content">
        @if (!authState.isAuthenticated) {
          <li role="menuitem">
            <app-button variant="primary" size="lg" (btnClick)="onLoginClick()">INICIAR SESIÓN</app-button>
          </li>
          <li role="menuitem">
            <app-button variant="primary" size="lg" (btnClick)="onRegisterClick()">CREAR CUENTA</app-button>
          </li>
        }
        
        @if (authState.isAuthenticated && authState.user) {
          <li role="menuitem">
            <app-button variant="primary" size="lg" (btnClick)="goToHome()">
              <fa-icon [icon]="['fas', 'home']" style="margin-right: 0.5rem;"></fa-icon> INICIO
            </app-button>
          </li>
          <li role="menuitem">
            <app-button variant="primary" size="lg" (btnClick)="goToProfile()">
              <fa-icon [icon]="['fas', 'user-circle']" style="margin-right: 0.5rem;"></fa-icon> PERFIL
            </app-button>
          </li>
          <li role="menuitem">
            <app-button variant="primary" size="lg" (btnClick)="goToSettings()">
              <fa-icon [icon]="['fas', 'cog']" style="margin-right: 0.5rem;"></fa-icon> AJUSTES
            </app-button>
          </li>
          <li role="menuitem">
            <app-button variant="primary" size="lg" (btnClick)="logout()">
              <fa-icon [icon]="['fas', 'sign-out-alt']" style="margin-right: 0.5rem;"></fa-icon> CERRAR SESIÓN
            </app-button>
          </li>
        }
      </ul>
    </nav>

    <!-- Overlay para cerrar menú -->
    @if (isMenuOpen) {
      <aside 
        class="header__overlay" 
        (click)="closeMenu()" 
        aria-hidden="true"
        role="presentation">
      </aside>
    }
  </section>

  <!-- Buscador móvil expandido (fuera del contenedor para ancho completo) -->
  @if (isMobileSearchOpen) {
    <section class="header__mobile-search" #mobileSearchContainer>
      <app-search-box 
        #mobileSearchBox
        placeholder="Buscar juegos..."
        [(value)]="mobileSearchQuery"
        (search)="onMobileSearch($event)">
      </app-search-box>
      <button 
        class="header__mobile-search-close" 
        (click)="closeMobileSearch()"
        aria-label="Cerrar búsqueda"
        type="button">
        <fa-icon [icon]="['fas', 'times']"></fa-icon>
      </button>
    </section>
  }
</header>
